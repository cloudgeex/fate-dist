import { __decorate, __read, __spread } from "tslib";
import { Injectable } from '@angular/core';
import { FateNode } from './fate-node';
import { FateType } from './fate-type.enum';
import * as i0 from "@angular/core";
var FateHtmlParserService = /** @class */ (function () {
    function FateHtmlParserService() {
    }
    FateHtmlParserService.prototype.parse = function (html) {
        var div = document.createElement('div');
        div.innerHTML = html;
        return this.parseElement(div);
    };
    ;
    FateHtmlParserService.prototype.parseElement = function (element) {
        var nodes = this.parseType(element);
        var currentNode = nodes[0];
        var isABlock = (currentNode.type === FateType.PARAGRAPH);
        for (var i = 1; i < nodes.length; i++) {
            currentNode.children.push(nodes[i]);
            currentNode = nodes[i];
            if (currentNode.type === FateType.PARAGRAPH) {
                isABlock = true;
            }
        }
        var previousNodeWasText = false;
        for (var i = 0; i < element.childNodes.length; i++) {
            var child = element.childNodes[i];
            // pick ahead to look for <br>
            if ((i < element.childNodes.length - 1) &&
                (this.isLinebreak(element.childNodes[i + 1])) &&
                !(isABlock && i === element.childNodes.length - 2) // The last child is a BR in a block, this can be ignored
            ) {
                previousNodeWasText = false;
                if (child instanceof Text) {
                    // wrap the text in a paragraph
                    var paragraph = new FateNode(FateType.PARAGRAPH);
                    paragraph.children.push(child.data);
                    currentNode.children.push(paragraph);
                }
                else if (child instanceof HTMLElement) {
                    // insert an empty paragraph
                    currentNode.children.push(this.parseElement(child));
                    currentNode.children.push(new FateNode(FateType.PARAGRAPH));
                }
                else {
                    // ignore
                }
            }
            else {
                if (child instanceof Text) {
                    // If two "pure" text node follow one another we can safely merge then as one (for i > 0)
                    if (previousNodeWasText) {
                        currentNode.children[currentNode.children.length - 1] = currentNode.children[currentNode.children.length - 1] + child.data;
                    }
                    else {
                        currentNode.children.push(child.data);
                    }
                    previousNodeWasText = true;
                }
                else if (child instanceof HTMLElement) {
                    currentNode.children.push(this.parseElement(child));
                    previousNodeWasText = false;
                }
                else {
                    // ignore
                }
            }
        }
        return nodes[0];
    };
    FateHtmlParserService.prototype.findParentNodes = function (node, until) {
        var nodes = [];
        var current = (node.nodeType === 1) ? node : node.parentElement;
        while (current !== until) {
            nodes.push.apply(nodes, __spread(this.parseType(current)));
            current = current.parentElement;
        }
        return nodes;
    };
    FateHtmlParserService.prototype.getAdditonalStyle = function (element) {
        var style = element.style;
        var detectedStyleNode = [];
        // Look for alignement
        var align = element.getAttribute('align') || style.textAlign;
        switch (align) {
            case 'left':
                detectedStyleNode.push(new FateNode(FateType.ALIGN_LEFT));
                break;
            case 'center':
                detectedStyleNode.push(new FateNode(FateType.ALIGN_CENTER));
                break;
            case 'right':
                detectedStyleNode.push(new FateNode(FateType.ALIGN_RIGHT));
                break;
            case 'justify':
                detectedStyleNode.push(new FateNode(FateType.JUSTIFY));
                break;
        }
        // Look for color
        var color = element.getAttribute('color') || style.color;
        if (color) {
            detectedStyleNode.push(new FateNode(FateType.COLOR, color));
        }
        // Look for size
        var size = element.getAttribute('size') || style.fontSize;
        if (size) {
            detectedStyleNode.push(new FateNode(FateType.SIZE, size));
        }
        // Look for family
        var typeface = element.getAttribute('face') || style.fontFamily;
        if (typeface) {
            detectedStyleNode.push(new FateNode(FateType.TYPEFACE, typeface));
        }
        return detectedStyleNode;
    };
    FateHtmlParserService.prototype.parseType = function (element) {
        var additionaStyle = this.getAdditonalStyle(element);
        switch (element.nodeName) {
            case 'H1':
                return __spread([new FateNode(FateType.HEADER1)], additionaStyle);
            case 'H2':
                return __spread([new FateNode(FateType.HEADER2)], additionaStyle);
            case 'H3':
                return __spread([new FateNode(FateType.HEADER3)], additionaStyle);
            case 'H4':
                return __spread([new FateNode(FateType.HEADER4)], additionaStyle);
            case 'H5':
                return __spread([new FateNode(FateType.HEADER5)], additionaStyle);
            case 'H6':
                return __spread([new FateNode(FateType.HEADER6)], additionaStyle);
            case 'B':
            case 'STRONG':
                return [new FateNode(FateType.BOLD)];
            case 'I':
            case 'EM':
                return [new FateNode(FateType.ITALIC)];
            case 'U':
                return [new FateNode(FateType.UNDERLINE)];
            case 'STRIKE':
                return [new FateNode(FateType.STRIKETHROUGH)];
            case 'SUB':
                return [new FateNode(FateType.SUBSCRIPT)];
            case 'SUP':
                return [new FateNode(FateType.SUPERSCRIPT)];
            case 'A':
                return [new FateNode(FateType.LINK, element.getAttribute('href'))];
            case 'OL':
                return [new FateNode(FateType.ORDERED_LIST)];
            case 'UL':
                return [new FateNode(FateType.UNORDERED_LIST)];
            case 'LI':
                return [new FateNode(FateType.LISTITEM)];
            case 'DIV':
            case 'P':
                if (additionaStyle.length > 0) {
                    return __spread(additionaStyle);
                }
                return [new FateNode(FateType.PARAGRAPH)];
            case 'BLOCKQUOTE':
                // FIXME: this doesn't work on FF
                if (element.style.marginLeft === '40px') {
                    return [new FateNode(FateType.INDENT)];
                }
                return [new FateNode(FateType.NONE)];
            default:
                if (additionaStyle.length > 0) {
                    return __spread(additionaStyle);
                }
                return [new FateNode(FateType.NONE)];
        }
    };
    FateHtmlParserService.prototype.parseValue = function (element) {
        switch (element.nodeName) {
            case 'A':
                return element.getAttribute('href');
        }
        return undefined;
    };
    FateHtmlParserService.prototype.serializeType = function (node) {
        switch (node.type) {
            case FateType.PARAGRAPH:
                return '<div>' + this.serialize(node, true) + '</div>';
            case FateType.HEADER1:
                return '<h1>' + this.serialize(node, true) + '</h1>';
            case FateType.HEADER2:
                return '<h2>' + this.serialize(node, true) + '</h2>';
            case FateType.HEADER3:
                return '<h3>' + this.serialize(node, true) + '</h3>';
            case FateType.HEADER4:
                return '<h4>' + this.serialize(node, true) + '</h4>';
            case FateType.HEADER5:
                return '<h5>' + this.serialize(node, true) + '</h5>';
            case FateType.HEADER6:
                return '<h6>' + this.serialize(node, true) + '</h6>';
            case FateType.QUOTE:
                return '<quote>' + this.serialize(node) + '</quote>';
            case FateType.CODE:
                return '<code>' + this.serialize(node) + '</code>';
            case FateType.BOLD:
                return '<strong>' + this.serialize(node) + '</strong>';
            case FateType.ITALIC:
                return '<em>' + this.serialize(node) + '</em>';
            case FateType.UNDERLINE:
                return '<u>' + this.serialize(node) + '</u>';
            case FateType.STRIKETHROUGH:
                return '<strike>' + this.serialize(node) + '</strike>';
            case FateType.SUBSCRIPT:
                return '<sub>' + this.serialize(node) + '</sub>';
            case FateType.SUPERSCRIPT:
                return '<sup>' + this.serialize(node) + '</sup>';
            case FateType.LINK:
                return '<a href="' + node.value + '">' + this.serialize(node) + '</a>';
            case FateType.ORDERED_LIST:
                return '<ol>' + this.serialize(node) + '</ol>';
            case FateType.UNORDERED_LIST:
                return '<ul>' + this.serialize(node) + '</ul>';
            case FateType.LISTITEM:
                return '<li>' + this.serialize(node) + '</li>';
            case FateType.ALIGN_LEFT:
                return '<div style="text-align: left;">' + this.serialize(node, true) + '</div>';
            case FateType.ALIGN_CENTER:
                return '<div style="text-align: center;">' + this.serialize(node, true) + '</div>';
            case FateType.ALIGN_RIGHT:
                return '<div style="text-align: right">' + this.serialize(node, true) + '</div>';
            case FateType.JUSTIFY:
                return '<div style="text-align: justify;">' + this.serialize(node, true) + '</div>';
            case FateType.INDENT:
                return '<blockquote style="margin-left: 40px">' + this.serialize(node, true) + '</blockquote>';
            case FateType.COLOR:
                return '<font color="' + node.value + '">' + this.serialize(node) + '</font>';
            case FateType.SIZE:
                return '<font size="' + node.value + '">' + this.serialize(node) + '</font>';
            case FateType.TYPEFACE:
                return '<font face="' + node.value + '">' + this.serialize(node) + '</font>';
            case FateType.NONE:
                return this.serialize(node);
        }
    };
    ;
    FateHtmlParserService.prototype.isLinebreak = function (child) {
        return (child instanceof HTMLElement && child.nodeName === 'BR');
    };
    // Saves a Tree in string representation
    FateHtmlParserService.prototype.serialize = function (node, fallbackToBr) {
        var _this = this;
        if (fallbackToBr === void 0) { fallbackToBr = false; }
        var serialized = '';
        node.children.forEach(function (child) {
            if (typeof child === 'string') {
                serialized += child;
            }
            else {
                serialized += _this.serializeType(child);
            }
        });
        if (fallbackToBr && !serialized) {
            serialized = '<br>';
        }
        return serialized;
    };
    ;
    FateHtmlParserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FateHtmlParserService_Factory() { return new FateHtmlParserService(); }, token: FateHtmlParserService, providedIn: "root" });
    FateHtmlParserService = __decorate([
        Injectable({
            providedIn: 'root'
        })
    ], FateHtmlParserService);
    return FateHtmlParserService;
}());
export { FateHtmlParserService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmF0ZS1odG1sLXBhcnNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vZmF0ZS1lZGl0b3IvIiwic291cmNlcyI6WyJhcHAvZmF0ZS1odG1sLXBhcnNlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztBQUs1QztJQUVFO0lBQWdCLENBQUM7SUFFVixxQ0FBSyxHQUFaLFVBQWEsSUFBWTtRQUN2QixJQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBQUEsQ0FBQztJQUVLLDRDQUFZLEdBQW5CLFVBQW9CLE9BQW9CO1FBQ3RDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTNCLElBQUksUUFBUSxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEMsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QixJQUFJLFdBQVcsQ0FBQyxJQUFJ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QUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUM7WUFDekQsS0FBSyxRQUFRLENBQUMsTUFBTTtnQkFDbEIsT0FBTyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDakQsS0FBSyxRQUFRLENBQUMsU0FBUztnQkFDckIsT0FBTyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDL0MsS0FBSyxRQUFRLENBQUMsYUFBYTtnQkFDekIsT0FBTyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUM7WUFDekQsS0FBSyxRQUFRLENBQUMsU0FBUztnQkFDckIsT0FBTyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDbkQsS0FBSyxRQUFRLENBQUMsV0FBVztnQkFDdkIsT0FBTyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDbkQsS0FBSyxRQUFRLENBQUMsSUFBSTtnQkFDaEIsT0FBTyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDekUsS0FBSyxRQUFRLENBQUMsWUFBWTtnQkFDeEIsT0FBTyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDakQsS0FBSyxRQUFRLENBQUMsY0FBYztnQkFDMUIsT0FBTyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDakQsS0FBSyxRQUFRLENBQUMsUUFBUTtnQkFDcEIsT0FBTyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDakQsS0FBSyxRQUFRLENBQUMsVUFBVTtnQkFDdEIsT0FBTyxpQ0FBaUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDbkYsS0FBSyxRQUFRLENBQUMsWUFBWTtnQkFDeEIsT0FBTyxtQ0FBbUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDckYsS0FBSyxRQUFRLENBQUMsV0FBVztnQkFDdkIsT0FBTyxpQ0FBaUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDbkYsS0FBSyxRQUFRLENBQUMsT0FBTztnQkFDbkIsT0FBTyxvQ0FBb0MsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7WUFDdEYsS0FBSyxRQUFRLENBQUMsTUFBTTtnQkFDbEIsT0FBTyx3Q0FBd0MsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxlQUFlLENBQUM7WUFDakcsS0FBSyxRQUFRLENBQUMsS0FBSztnQkFDakIsT0FBTyxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7WUFDaEYsS0FBSyxRQUFRLENBQUMsSUFBSTtnQkFDaEIsT0FBTyxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7WUFDL0UsS0FBSyxRQUFRLENBQUMsUUFBUTtnQkFDcEIsT0FBTyxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7WUFDL0UsS0FBSyxRQUFRLENBQUMsSUFBSTtnQkFDaEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUFBLENBQUM7SUFFUSwyQ0FBVyxHQUFyQixVQUFzQixLQUFXO1FBQy9CLE9BQU8sQ0FBQyxLQUFLLFlBQVksV0FBVyxJQUFJLEtBQUssQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVELHdDQUF3QztJQUNqQyx5Q0FBUyxHQUFoQixVQUFrQixJQUFjLEVBQUUsWUFBNkI7UUFBL0QsaUJBYUM7UUFiaUMsNkJBQUEsRUFBQSxvQkFBNkI7UUFDN0QsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSztZQUMxQixJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtnQkFDN0IsVUFBVSxJQUFJLEtBQUssQ0FBQzthQUNyQjtpQkFBTTtnQkFDTCxVQUFVLElBQUksS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN6QztRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxZQUFZLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDL0IsVUFBVSxHQUFHLE1BQU0sQ0FBQztTQUNyQjtRQUNELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFBQSxDQUFDOztJQWxRUyxxQkFBcUI7UUFIakMsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztPQUNXLHFCQUFxQixDQW1RakM7Z0NBM1FEO0NBMlFDLEFBblFELElBbVFDO1NBblFZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRmF0ZU5vZGUgfSBmcm9tICcuL2ZhdGUtbm9kZSc7XG5pbXBvcnQgeyBGYXRlVHlwZSB9IGZyb20gJy4vZmF0ZS10eXBlLmVudW0nO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBGYXRlSHRtbFBhcnNlclNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgcHVibGljIHBhcnNlKGh0bWw6IHN0cmluZyk6IEZhdGVOb2RlIHtcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkaXYuaW5uZXJIVE1MID0gaHRtbDtcbiAgICByZXR1cm4gdGhpcy5wYXJzZUVsZW1lbnQoZGl2KTtcbiAgfTtcblxuICBwdWJsaWMgcGFyc2VFbGVtZW50KGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogRmF0ZU5vZGUge1xuICAgIGNvbnN0IG5vZGVzID0gdGhpcy5wYXJzZVR5cGUoZWxlbWVudCk7XG4gICAgbGV0IGN1cnJlbnROb2RlID0gbm9kZXNbMF07XG4gICAgXG4gICAgbGV0IGlzQUJsb2NrID0gKGN1cnJlbnROb2RlLnR5cGUgPT09IEZhdGVUeXBlLlBBUkFHUkFQSCk7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY3VycmVudE5vZGUuY2hpbGRyZW4ucHVzaChub2Rlc1tpXSk7XG4gICAgICBjdXJyZW50Tm9kZSA9IG5vZGVzW2ldO1xuICAgICAgaWYgKGN1cnJlbnROb2RlLnR5cGUgPT09IEZhdGVUeXBlLlBBUkFHUkFQSCkge1xuICAgICAgICBpc0FCbG9jayA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHByZXZpb3VzTm9kZVdhc1RleHQgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkgKyspIHtcbiAgICAgIGNvbnN0IGNoaWxkID0gZWxlbWVudC5jaGlsZE5vZGVzW2ldO1xuICAgICAgLy8gcGljayBhaGVhZCB0byBsb29rIGZvciA8YnI+XG4gICAgICBpZiAoXG4gICAgICAgICAgKGkgPCBlbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoIC0gMSkgJiZcbiAgICAgICAgICAodGhpcy5pc0xpbmVicmVhayhlbGVtZW50LmNoaWxkTm9kZXNbaSArIDFdKSkgJiZcbiAgICAgICAgICAhKGlzQUJsb2NrICYmIGkgPT09IGVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggLSAyKSAvLyBUaGUgbGFzdCBjaGlsZCBpcyBhIEJSIGluIGEgYmxvY2ssIHRoaXMgY2FuIGJlIGlnbm9yZWRcbiAgICAgICAgKSB7XG5cbiAgICAgICAgcHJldmlvdXNOb2RlV2FzVGV4dCA9IGZhbHNlO1xuICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBUZXh0KSB7XG4gICAgICAgICAgLy8gd3JhcCB0aGUgdGV4dCBpbiBhIHBhcmFncmFwaFxuICAgICAgICAgIGNvbnN0IHBhcmFncmFwaCA9IG5ldyBGYXRlTm9kZShGYXRlVHlwZS5QQVJBR1JBUEgpO1xuICAgICAgICAgIHBhcmFncmFwaC5jaGlsZHJlbi5wdXNoKGNoaWxkLmRhdGEpO1xuICAgICAgICAgIGN1cnJlbnROb2RlLmNoaWxkcmVuLnB1c2gocGFyYWdyYXBoKTtcbiAgICAgICAgfSBlbHNlIGlmIChjaGlsZCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgLy8gaW5zZXJ0IGFuIGVtcHR5IHBhcmFncmFwaFxuICAgICAgICAgIGN1cnJlbnROb2RlLmNoaWxkcmVuLnB1c2godGhpcy5wYXJzZUVsZW1lbnQoY2hpbGQpKTtcbiAgICAgICAgICBjdXJyZW50Tm9kZS5jaGlsZHJlbi5wdXNoKG5ldyBGYXRlTm9kZShGYXRlVHlwZS5QQVJBR1JBUEgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBpZ25vcmVcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgVGV4dCkge1xuICAgICAgICAgIC8vIElmIHR3byBcInB1cmVcIiB0ZXh0IG5vZGUgZm9sbG93IG9uZSBhbm90aGVyIHdlIGNhbiBzYWZlbHkgbWVyZ2UgdGhlbiBhcyBvbmUgKGZvciBpID4gMClcbiAgICAgICAgICBpZiAocHJldmlvdXNOb2RlV2FzVGV4dCkge1xuICAgICAgICAgICAgY3VycmVudE5vZGUuY2hpbGRyZW5bY3VycmVudE5vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMV0gPSBjdXJyZW50Tm9kZS5jaGlsZHJlbltjdXJyZW50Tm9kZS5jaGlsZHJlbi5sZW5ndGggLSAxXSArIGNoaWxkLmRhdGE7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnROb2RlLmNoaWxkcmVuLnB1c2goY2hpbGQuZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHByZXZpb3VzTm9kZVdhc1RleHQgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKGNoaWxkIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgICBjdXJyZW50Tm9kZS5jaGlsZHJlbi5wdXNoKHRoaXMucGFyc2VFbGVtZW50KGNoaWxkKSk7XG4gICAgICAgICAgcHJldmlvdXNOb2RlV2FzVGV4dCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIGlnbm9yZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBub2Rlc1swXTtcbiAgfVxuXG4gIHB1YmxpYyBmaW5kUGFyZW50Tm9kZXMobm9kZTogTm9kZSwgdW50aWw6IE5vZGUpOiBBcnJheTxGYXRlTm9kZT4ge1xuICAgIGNvbnN0IG5vZGVzOiBBcnJheTxGYXRlTm9kZT4gPSBbXTtcbiAgICBsZXQgY3VycmVudDogSFRNTEVsZW1lbnQgPSAobm9kZS5ub2RlVHlwZSA9PT0gMSkgPyAobm9kZSBhcyBIVE1MRWxlbWVudCkgOiBub2RlLnBhcmVudEVsZW1lbnQ7XG4gICAgd2hpbGUgKGN1cnJlbnQgIT09IHVudGlsKSB7XG4gICAgICBub2Rlcy5wdXNoKC4uLnRoaXMucGFyc2VUeXBlKGN1cnJlbnQpKTtcbiAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuICAgIHJldHVybiBub2RlcztcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRBZGRpdG9uYWxTdHlsZShlbGVtZW50OiBIVE1MRWxlbWVudCk6IEFycmF5PEZhdGVOb2RlPiB7XG4gICAgY29uc3Qgc3R5bGUgPSBlbGVtZW50LnN0eWxlO1xuICAgIGNvbnN0IGRldGVjdGVkU3R5bGVOb2RlID0gW107XG4gICAgLy8gTG9vayBmb3IgYWxpZ25lbWVudFxuICAgIGNvbnN0IGFsaWduID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2FsaWduJykgfHwgc3R5bGUudGV4dEFsaWduO1xuICAgIHN3aXRjaCAoYWxpZ24pIHtcbiAgICAgIGNhc2UgJ2xlZnQnOlxuICAgICAgICBkZXRlY3RlZFN0eWxlTm9kZS5wdXNoKG5ldyBGYXRlTm9kZShGYXRlVHlwZS5BTElHTl9MRUZUKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY2VudGVyJzpcbiAgICAgICAgZGV0ZWN0ZWRTdHlsZU5vZGUucHVzaChuZXcgRmF0ZU5vZGUoRmF0ZVR5cGUuQUxJR05fQ0VOVEVSKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncmlnaHQnOlxuICAgICAgICBkZXRlY3RlZFN0eWxlTm9kZS5wdXNoKG5ldyBGYXRlTm9kZShGYXRlVHlwZS5BTElHTl9SSUdIVCkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2p1c3RpZnknOlxuICAgICAgICBkZXRlY3RlZFN0eWxlTm9kZS5wdXNoKG5ldyBGYXRlTm9kZShGYXRlVHlwZS5KVVNUSUZZKSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICAvLyBMb29rIGZvciBjb2xvclxuICAgIGNvbnN0IGNvbG9yID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NvbG9yJykgfHwgc3R5bGUuY29sb3I7XG4gICAgaWYoY29sb3IpIHtcbiAgICAgIGRldGVjdGVkU3R5bGVOb2RlLnB1c2gobmV3IEZhdGVOb2RlKEZhdGVUeXBlLkNPTE9SLCBjb2xvcikpO1xuICAgIH1cbiAgICAvLyBMb29rIGZvciBzaXplXG4gICAgY29uc3Qgc2l6ZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdzaXplJykgfHwgc3R5bGUuZm9udFNpemU7XG4gICAgaWYgKHNpemUpIHtcbiAgICAgIGRldGVjdGVkU3R5bGVOb2RlLnB1c2gobmV3IEZhdGVOb2RlKEZhdGVUeXBlLlNJWkUsIHNpemUpKTtcbiAgICB9XG4gICAgLy8gTG9vayBmb3IgZmFtaWx5XG4gICAgY29uc3QgdHlwZWZhY2UgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZmFjZScpIHx8IHN0eWxlLmZvbnRGYW1pbHk7XG4gICAgaWYgKHR5cGVmYWNlKSB7XG4gICAgICBkZXRlY3RlZFN0eWxlTm9kZS5wdXNoKG5ldyBGYXRlTm9kZShGYXRlVHlwZS5UWVBFRkFDRSwgdHlwZWZhY2UpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGV0ZWN0ZWRTdHlsZU5vZGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VUeXBlKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogQXJyYXk8RmF0ZU5vZGU+IHtcbiAgICBjb25zdCBhZGRpdGlvbmFTdHlsZSA9IHRoaXMuZ2V0QWRkaXRvbmFsU3R5bGUoZWxlbWVudCk7XG4gICAgc3dpdGNoIChlbGVtZW50Lm5vZGVOYW1lKSB7XG4gICAgICBjYXNlICdIMSc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjEpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdIMic6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjIpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdIMyc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjMpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdINCc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjQpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdINSc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjUpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdINic6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkhFQURFUjYpLCAuLi5hZGRpdGlvbmFTdHlsZV07XG4gICAgICBjYXNlICdCJzpcbiAgICAgIGNhc2UgJ1NUUk9ORyc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLkJPTEQpXTtcbiAgICAgIGNhc2UgJ0knOlxuICAgICAgY2FzZSAnRU0nOlxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5JVEFMSUMpXTtcbiAgICAgIGNhc2UgJ1UnOlxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5VTkRFUkxJTkUpXTtcbiAgICAgIGNhc2UgJ1NUUklLRSc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLlNUUklLRVRIUk9VR0gpXTtcbiAgICAgIGNhc2UgJ1NVQic6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLlNVQlNDUklQVCldO1xuICAgICAgY2FzZSAnU1VQJzpcbiAgICAgICAgcmV0dXJuIFtuZXcgRmF0ZU5vZGUoRmF0ZVR5cGUuU1VQRVJTQ1JJUFQpXTtcbiAgICAgIGNhc2UgJ0EnOlxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5MSU5LLCBlbGVtZW50LmdldEF0dHJpYnV0ZSgnaHJlZicpKV07XG4gICAgICBjYXNlICdPTCc6XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLk9SREVSRURfTElTVCldO1xuICAgICAgY2FzZSAnVUwnOlxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5VTk9SREVSRURfTElTVCldO1xuICAgICAgY2FzZSAnTEknOlxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5MSVNUSVRFTSldO1xuICAgICAgY2FzZSAnRElWJzpcbiAgICAgIGNhc2UgJ1AnOlxuICAgICAgICBpZiAoYWRkaXRpb25hU3R5bGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHJldHVybiBbLi4uYWRkaXRpb25hU3R5bGVdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLlBBUkFHUkFQSCldO1xuICAgICAgY2FzZSAnQkxPQ0tRVU9URSc6XG4gICAgICAgIC8vIEZJWE1FOiB0aGlzIGRvZXNuJ3Qgd29yayBvbiBGRlxuICAgICAgICBpZiAoZWxlbWVudC5zdHlsZS5tYXJnaW5MZWZ0ID09PSAnNDBweCcpIHtcbiAgICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5JTkRFTlQpXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW25ldyBGYXRlTm9kZShGYXRlVHlwZS5OT05FKV07XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBpZiAoYWRkaXRpb25hU3R5bGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHJldHVybiBbLi4uYWRkaXRpb25hU3R5bGVdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbbmV3IEZhdGVOb2RlKEZhdGVUeXBlLk5PTkUpXTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VWYWx1ZShlbGVtZW50OiBIVE1MRWxlbWVudCk6IGFueSB7XG4gICAgc3dpdGNoIChlbGVtZW50Lm5vZGVOYW1lKSB7XG4gICAgICBjYXNlICdBJzpcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdocmVmJyk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2VyaWFsaXplVHlwZShub2RlOiBGYXRlTm9kZSk6IHN0cmluZyB7XG4gICAgc3dpdGNoIChub2RlLnR5cGUpIHtcbiAgICAgIGNhc2UgRmF0ZVR5cGUuUEFSQUdSQVBIOlxuICAgICAgICByZXR1cm4gJzxkaXY+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUsIHRydWUpICsgJzwvZGl2Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjE6XG4gICAgICAgIHJldHVybiAnPGgxPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2gxPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjI6XG4gICAgICAgIHJldHVybiAnPGgyPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2gyPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjM6XG4gICAgICAgIHJldHVybiAnPGgzPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2gzPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjQ6XG4gICAgICAgIHJldHVybiAnPGg0PicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2g0Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjU6XG4gICAgICAgIHJldHVybiAnPGg1PicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2g1Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkhFQURFUjY6XG4gICAgICAgIHJldHVybiAnPGg2PicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2g2Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLlFVT1RFOlxuICAgICAgICByZXR1cm4gJzxxdW90ZT4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC9xdW90ZT4nO1xuICAgICAgY2FzZSBGYXRlVHlwZS5DT0RFOlxuICAgICAgICByZXR1cm4gJzxjb2RlPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlKSArICc8L2NvZGU+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuQk9MRDpcbiAgICAgICAgcmV0dXJuICc8c3Ryb25nPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlKSArICc8L3N0cm9uZz4nO1xuICAgICAgY2FzZSBGYXRlVHlwZS5JVEFMSUM6XG4gICAgICAgIHJldHVybiAnPGVtPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlKSArICc8L2VtPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLlVOREVSTElORTpcbiAgICAgICAgcmV0dXJuICc8dT4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC91Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLlNUUklLRVRIUk9VR0g6XG4gICAgICAgIHJldHVybiAnPHN0cmlrZT4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC9zdHJpa2U+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuU1VCU0NSSVBUOlxuICAgICAgICByZXR1cm4gJzxzdWI+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUpICsgJzwvc3ViPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLlNVUEVSU0NSSVBUOlxuICAgICAgICByZXR1cm4gJzxzdXA+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUpICsgJzwvc3VwPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkxJTks6XG4gICAgICAgIHJldHVybiAnPGEgaHJlZj1cIicgKyBub2RlLnZhbHVlICsgJ1wiPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlKSArICc8L2E+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuT1JERVJFRF9MSVNUOlxuICAgICAgICByZXR1cm4gJzxvbD4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC9vbD4nO1xuICAgICAgY2FzZSBGYXRlVHlwZS5VTk9SREVSRURfTElTVDpcbiAgICAgICAgcmV0dXJuICc8dWw+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUpICsgJzwvdWw+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuTElTVElURU06XG4gICAgICAgIHJldHVybiAnPGxpPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlKSArICc8L2xpPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkFMSUdOX0xFRlQ6XG4gICAgICAgIHJldHVybiAnPGRpdiBzdHlsZT1cInRleHQtYWxpZ246IGxlZnQ7XCI+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUsIHRydWUpICsgJzwvZGl2Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkFMSUdOX0NFTlRFUjpcbiAgICAgICAgcmV0dXJuICc8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogY2VudGVyO1wiPicgKyB0aGlzLnNlcmlhbGl6ZShub2RlLCB0cnVlKSArICc8L2Rpdj4nO1xuICAgICAgY2FzZSBGYXRlVHlwZS5BTElHTl9SSUdIVDpcbiAgICAgICAgcmV0dXJuICc8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogcmlnaHRcIj4nICsgdGhpcy5zZXJpYWxpemUobm9kZSwgdHJ1ZSkgKyAnPC9kaXY+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuSlVTVElGWTpcbiAgICAgICAgcmV0dXJuICc8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjoganVzdGlmeTtcIj4nICsgdGhpcy5zZXJpYWxpemUobm9kZSwgdHJ1ZSkgKyAnPC9kaXY+JztcbiAgICAgIGNhc2UgRmF0ZVR5cGUuSU5ERU5UOlxuICAgICAgICByZXR1cm4gJzxibG9ja3F1b3RlIHN0eWxlPVwibWFyZ2luLWxlZnQ6IDQwcHhcIj4nICsgdGhpcy5zZXJpYWxpemUobm9kZSwgdHJ1ZSkgKyAnPC9ibG9ja3F1b3RlPic7XG4gICAgICBjYXNlIEZhdGVUeXBlLkNPTE9SOlxuICAgICAgICByZXR1cm4gJzxmb250IGNvbG9yPVwiJyArIG5vZGUudmFsdWUgKyAnXCI+JyArIHRoaXMuc2VyaWFsaXplKG5vZGUpICsgJzwvZm9udD4nO1xuICAgICAgY2FzZSBGYXRlVHlwZS5TSVpFOlxuICAgICAgICByZXR1cm4gJzxmb250IHNpemU9XCInICsgbm9kZS52YWx1ZSArICdcIj4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC9mb250Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLlRZUEVGQUNFOlxuICAgICAgICByZXR1cm4gJzxmb250IGZhY2U9XCInICsgbm9kZS52YWx1ZSArICdcIj4nICsgdGhpcy5zZXJpYWxpemUobm9kZSkgKyAnPC9mb250Pic7XG4gICAgICBjYXNlIEZhdGVUeXBlLk5PTkU6XG4gICAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZShub2RlKTtcbiAgICB9XG4gIH07XG5cbiAgcHJvdGVjdGVkIGlzTGluZWJyZWFrKGNoaWxkOiBOb2RlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChjaGlsZCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIGNoaWxkLm5vZGVOYW1lID09PSAnQlInKTtcbiAgfVxuXG4gIC8vIFNhdmVzIGEgVHJlZSBpbiBzdHJpbmcgcmVwcmVzZW50YXRpb25cbiAgcHVibGljIHNlcmlhbGl6ZSAobm9kZTogRmF0ZU5vZGUsIGZhbGxiYWNrVG9CcjogYm9vbGVhbiA9IGZhbHNlKTogc3RyaW5nIHtcbiAgICBsZXQgc2VyaWFsaXplZCA9ICcnO1xuICAgIG5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHNlcmlhbGl6ZWQgKz0gY2hpbGQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZXJpYWxpemVkICs9IHRoaXMuc2VyaWFsaXplVHlwZShjaGlsZCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGZhbGxiYWNrVG9CciAmJiAhc2VyaWFsaXplZCkge1xuICAgICAgc2VyaWFsaXplZCA9ICc8YnI+JztcbiAgICB9XG4gICAgcmV0dXJuIHNlcmlhbGl6ZWQ7XG4gIH07XG59XG4iXX0=